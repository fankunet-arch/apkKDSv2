# TOPTEA KDS 系统设计说明书

> **文档版本**: 2.0
> **项目名称**: TOPTEA KDS (Kitchen Display System)

---

## 目录

1. [系统概述](#1-系统概述)
2. [系统架构设计](#2-系统架构设计)
3. [核心功能模块设计](#3-核心功能模块设计)
   - 3.1 [WebView 容器（主入口）](#31-webview-容器主入口)
   - 3.2 [JavaScript Bridge 桥接层](#32-javascript-bridge-桥接层)
   - 3.3 [打印服务](#33-打印服务)
   - 3.4 [配置管理](#34-配置管理)
   - 3.5 [条码扫描](#35-条码扫描)
   - 3.6 [取证拍照](#36-取证拍照)
4. [数据流与交互时序](#4-数据流与交互时序)
5. [权限模型与安全设计](#5-权限模型与安全设计)
6. [UI 交互设计](#6-ui-交互设计)
7. [注意事项与设计约束](#7-注意事项与设计约束)
8. [待实现功能](#8-待实现功能)

---

## 1. 系统概述

### 1.1 产品定位

TOPTEA KDS 是一款面向餐饮行业的 **厨房显示系统 (Kitchen Display System)** Android 客户端。它采用 **Hybrid App（混合应用）** 架构，核心业务逻辑运行在远程 Web 端，Android 端作为一个"硬件能力壳"，通过 JavaScript Bridge 向 Web 端暴露以下原生能力：

- **热敏打印机控制** — 支持 ESC/POS（收据）和 TSPL（标签）两种协议
- **条码/二维码扫描** — 基于摄像头实时图像分析
- **取证拍照** — 带 GPS 定位信息写入照片 EXIF 元数据
- **打印机配置持久化** — 本地保存打印机连接参数

### 1.2 核心设计理念

| 设计原则 | 说明 |
|---------|------|
| **Hybrid 架构** | 业务逻辑全部运行在 Web 端（订单管理、菜品显示等），Android 端**不包含任何业务逻辑**，仅提供硬件桥接能力。这样做的好处是：Web 端升级不需要重新发布 APK |
| **异步回调模型** | 所有 Native 操作均为异步。Web 端调用时传入"成功回调函数名"和"失败回调函数名"两个字符串，Native 操作完成后通过 `evaluateJavascript` 调用对应的全局函数 |
| **横屏锁定** | 所有界面强制横屏显示，适配厨房大屏显示器和横向平板场景 |
| **强制缓存清除** | 每次 APP 启动时强制清除 WebView 所有缓存（包括 Cookie、表单数据、本地存储目录），确保总是加载最新版本的 Web 应用。这是一个刻意的设计选择，牺牲启动速度换取"永远是最新版" |

### 1.3 目标运行环境

- **目标设备**: 厨房平板电脑、Android POS 一体机
- **屏幕方向**: 强制横屏 (landscape)
- **网络要求**: 必须具备网络连接（加载远程 Web 应用）；打印机通信走内网
- **硬件要求**: 必须具备摄像头（扫码和拍照功能依赖摄像头，应用声明了 `camera` 为必需硬件特性）

---

## 2. 系统架构设计

### 2.1 三层架构

系统分为三个层次：

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Web 应用层                                   │
│                                                                     │
│   所有业务逻辑（订单、菜品、厨房管理）在此层运行                       │
│   通过 window.AndroidBridge 调用原生能力                             │
│   ┌──────────────────────────────────────────────────────────────┐  │
│   │  window.AndroidBridge.printJob(payload, onSuccess, onError) │  │
│   │  window.AndroidBridge.startScan(onSuccess, onError)         │  │
│   │  window.AndroidBridge.savePrinterConfig(...)                │  │
│   │  window.AndroidBridge.takeEvidencePhoto(onSuccess, onError) │  │
│   └──────────────────────────────────────────────────────────────┘  │
└──────────────────────────────┬──────────────────────────────────────┘
                               │ JavaScript Bridge
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Android Native 层                               │
│                                                                     │
│  ┌─────────────────┐    ┌──────────────────┐    ┌───────────────┐  │
│  │  WebView 容器   │◄──►│  JS Bridge 接口  │◄──►│   打印服务    │  │
│  │  (主入口)       │    │  (4个公开方法)    │    │ (ESC/POS+TSPL)│  │
│  └────────┬────────┘    └──────────────────┘    └───────┬───────┘  │
│           │                                              │          │
│           │ Activity 跳转                                │          │
│           ▼                                              ▼          │
│  ┌─────────────────┐    ┌──────────────────┐    ┌───────────────┐  │
│  │   条码扫描      │    │    取证拍照      │    │   配置管理    │  │
│  │ (前置摄像头)    │    │(后置摄像头+GPS)  │    │(本地持久化)   │  │
│  └─────────────────┘    └──────────────────┘    └───────────────┘  │
└──────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        硬件层                                       │
│                                                                     │
│    热敏打印机(WiFi)    前置摄像头    后置摄像头    GPS    蓝牙模块   │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 通信模型

Web 与 Native 之间采用**异步回调函数名**通信模型：

**调用方向（Web → Native）**:
```
window.AndroidBridge.方法名(数据, "成功回调函数名", "失败回调函数名")
```

**回调方向（Native → Web）**:
```
webView.evaluateJavascript("window.成功回调函数名(参数)")
```

**关键设计决策**：
- Web 端传递的是**全局函数名的字符串**，而非函数引用。这是因为 `@JavascriptInterface` 注解的方法只能接收基本类型参数（String、int、boolean 等），不能接收 JavaScript 函数对象
- Native 端通过 `JSONObject.quote()` 对回调参数进行安全转义，防止引号等特殊字符破坏 JS 语法
- 所有 JS 回调必须通过 `runOnUiThread` 在主线程执行，因为 `evaluateJavascript` 必须在 UI 线程调用
- 回调使用 `try-catch` 包裹，防止 Web 端函数不存在时崩溃

### 2.3 线程模型

| 操作类型 | 运行线程 | 原因 |
|----------|----------|------|
| `@JavascriptInterface` 方法 | WebView Binder 线程 | Android WebView 机制决定 |
| 启动 Activity（扫码/拍照） | UI 线程 | Android 要求 |
| Socket 打印、配置读写 | IO 协程 | 避免阻塞 UI |
| JS 回调 (`evaluateJavascript`) | UI 线程 | Android WebView 要求 |

> **注意**: `@JavascriptInterface` 方法不运行在 UI 线程上，这是一个常见误解。必须根据操作类型手动切换到正确线程。

---

## 3. 核心功能模块设计

### 3.1 WebView 容器（主入口）

#### 功能描述

作为整个应用的主入口，承载一个全屏 WebView，加载远程 KDS Web 应用。负责协调所有子功能模块的启动和回调。

#### WebView 环境配置

| 配置项 | 设定值 | 设计原因 |
|--------|--------|----------|
| JavaScript | 开启 | Web 应用依赖 JavaScript 运行 |
| DOM Storage | 开启 | Web 应用需要使用 LocalStorage / SessionStorage 存储会话数据 |
| 数据库 | 开启 | Web 应用可能使用 IndexedDB 缓存离线数据 |
| 媒体自动播放 | 开启 | KDS 需要在新订单到达时**自动播放提示音**，不能要求用户手动触发 |
| 混合内容模式 | 全部允许 | Web 应用的 HTTPS 页面可能嵌入了 HTTP 资源（如内网图片） |

#### 缓存清除策略

**每次启动时**（`onCreate` 阶段、加载 URL 之前）强制执行以下 5 步清除：

1. 清除 WebView 内部缓存（包括磁盘和内存缓存）
2. 清除所有 Cookie
3. 刷新 Cookie 管理器（确保清除写入磁盘）
4. 清除表单自动填充数据
5. 递归删除 `app_webview` 目录（WebView 的私有数据目录）

> **注意**: 这意味着用户每次打开 APP 都需要重新加载全部 Web 资源。这是故意设计——KDS 场景下"总是最新"比"快速启动"更重要。如果未来需要优化启动速度，可以改为只清除特定缓存。

#### 错误处理

当 WebView 加载失败时（无论是网络错误还是 HTTP 错误），系统会显示一个内联的 HTML 错误页面：

- 显示"系统暂时无法访问"的友好提示
- 提供"重新加载"按钮
- **关键安全设计**: 错误页面**不暴露任何 URL 信息**（内网地址属于敏感信息），只在 Android Log 中记录 errorCode 和 description
- 仅对主页面的 HTTP 错误做处理，忽略子资源（图片、CSS等）的加载错误

#### `<input type="file">` 支持

Web 页面中的文件上传表单会触发两种不同行为：

| 触发场景 | 行为 |
|----------|------|
| HTML 中 `<input type="file" capture>` | 启动 CameraX 拍照界面（取证拍照模块），自动写入 GPS EXIF |
| HTML 中 `<input type="file">` （无 capture） | 打开系统相册/文件选择器，支持多文件选择 |

> **注意**: 在上一次文件选择回调尚未完成时，如果触发新的选择操作，系统会先取消上一次的回调（传入 null），再启动新的选择流程。

#### 返回键行为

- 如果 WebView 有浏览历史 → 后退到上一页
- 如果 WebView 没有历史 → 正常退出应用

---

### 3.2 JavaScript Bridge 桥接层

#### 功能描述

通过 `@JavascriptInterface` 注解将一个对象注入 WebView 的 JavaScript 全局作用域，名称为 `window.AndroidBridge`。Web 端通过这个对象调用 4 个原生能力。

#### 公开接口

**接口 1 — 打印 (`printJob`)**

```
window.AndroidBridge.printJob(jsonPayloadString, successCallbackName, errorCallbackName)
```

| 参数 | 类型 | 说明 |
|------|------|------|
| `jsonPayloadString` | String | JSON 格式的打印指令（含纸张尺寸和指令数组） |
| `successCallbackName` | String | 打印成功后调用的全局 JS 函数名 |
| `errorCallbackName` | String | 打印失败时调用的全局 JS 函数名，参数为错误消息 |

- 在 IO 协程中执行，不阻塞 WebView
- 委托给打印服务模块处理

---

**接口 2 — 扫码 (`startScan`)**

```
window.AndroidBridge.startScan(successCallbackName, errorCallbackName)
```

| 参数 | 类型 | 说明 |
|------|------|------|
| `successCallbackName` | String | 扫码成功后调用的全局 JS 函数名，参数为条码文本 |
| `errorCallbackName` | String | 扫码失败/取消时调用的全局 JS 函数名，参数为错误消息 |

- 在 UI 线程启动扫码 Activity
- 扫到第一个有效条码后自动返回结果

---

**接口 3 — 保存打印机配置 (`savePrinterConfig`)**

```
window.AndroidBridge.savePrinterConfig(type, ip, port, macAddress, successCallbackName, errorCallbackName)
```

| 参数 | 类型 | 说明 |
|------|------|------|
| `type` | String | 连接类型：`"WIFI"` / `"BLUETOOTH"` / `"USB"` |
| `ip` | String | 打印机 IP 地址（WiFi 模式使用） |
| `port` | int | 打印端口号（WiFi 模式使用，一般为 9100） |
| `macAddress` | String | 蓝牙 MAC 地址（蓝牙模式使用） |
| `successCallbackName` | String | 保存成功回调函数名 |
| `errorCallbackName` | String | 保存失败回调函数名 |

- 配置保存到设备本地（SharedPreferences），断电不丢失
- 在 IO 协程中执行

---

**接口 4 — 取证拍照 (`takeEvidencePhoto`)**

```
window.AndroidBridge.takeEvidencePhoto(successCallbackName, errorCallbackName)
```

| 参数 | 类型 | 说明 |
|------|------|------|
| `successCallbackName` | String | 拍照成功回调函数名，参数为 Base64 编码的 JPEG |
| `errorCallbackName` | String | 拍照失败/取消回调函数名，参数为错误消息 |

- 在 UI 线程启动拍照 Activity
- 拍出的照片自动嵌入 GPS 经纬度、时间戳、设备信息到 EXIF
- 返回 Base64 编码的 JPEG 字符串

#### 回调参数序列化规则

Native 向 Web 回调时，参数按以下规则序列化为 JS 代码：

| 参数类型 | 序列化方式 | 示例 |
|----------|-----------|------|
| String | `JSONObject.quote()` 安全转义 | `"hello \"world\""` |
| Number | 直接 `toString()` | `42` |
| Boolean | 直接 `toString()` | `true` |
| null | 字面量 `null` | `null` |

> **注意**: 必须使用 `JSONObject.quote()` 而非手动拼接引号，否则当字符串包含引号、换行等特殊字符时会导致 JS 语法错误或注入漏洞。

---

### 3.3 打印服务

#### 功能描述

接收 JSON 格式的打印指令，自动判断打印协议（ESC/POS 或 TSPL），建立与打印机的连接，将指令翻译为对应协议的字节流并发送。

#### 双协议设计

系统根据 JSON 负载中的 `size` 字段自动判断打印协议：

| 纸张尺寸格式 | 协议 | 场景 |
|-------------|------|------|
| `"58mm"` 或 `"80mm"` | **ESC/POS** | 热敏收据打印 |
| `"50x30 mm"` （包含 `x`） | **TSPL** | 标签/条码打印 |

判断规则很简单：`size` 字段中包含字母 `x` → TSPL 模式，否则 → ESC/POS 模式。

#### JSON 打印负载格式

```json
{
  "size": "80mm",
  "commands": [
    { "type": "text", "value": "订单 #1234" },
    { "type": "divider", "char": "-" },
    { "type": "kv", "key": "芒果冰沙", "value": "x2" },
    { "type": "kv", "key": "珍珠奶茶", "value": "x1" },
    { "type": "divider", "char": "=" },
    { "type": "feed", "lines": 3 },
    { "type": "cut" }
  ]
}
```

#### 支持的打印指令

| 指令类型 | 必要字段 | ESC/POS 行为 | TSPL 行为 |
|----------|----------|-------------|-----------|
| `text` | `value` | 以 GBK 编码输出文本 + 换行 | 在标签指定坐标输出中文文本 |
| `kv` | `key`, `value` | 输出 `key: value` 格式的键值对 | 同上，拼接为 `key: value` |
| `divider` | `char`（可选，默认 `-`） | 用指定字符填满一行（58mm=32列, 80mm=48列） | 暂未实现 |
| `feed` | `lines`（可选，默认 1） | 输出 N 个空行（走纸） | TSPL 不单独走纸 |
| `cut` | 无 | 发送全切指令 (GS V 1) | 不适用 |

#### 打印执行流程

```
1. 读取本地保存的打印机配置（连接类型、IP、端口）
2. 解析 JSON 负载，提取纸张尺寸和指令数组
3. 判断打印模式（ESC/POS 或 TSPL）
4. 建立连接（目前仅支持 WiFi Socket 连接）
5. 发送初始化指令
   - ESC/POS: ESC @ (复位打印机)
   - TSPL: SIZE + GAP + CLS (设置标签尺寸、间隙、清屏)
6. 逐条执行打印指令
7. 发送结束指令
   - ESC/POS: 额外走纸 + 最终切刀
   - TSPL: PRINT 1,1（打印一张）
8. 关闭连接（无论成功失败都在 finally 中执行）
```

#### 连接方式

| 连接类型 | 实现状态 | 连接方式 |
|----------|---------|----------|
| **WiFi** | 已实现 | 通过 TCP Socket 连接到打印机 IP:Port（默认端口 9100） |
| **蓝牙** | 未实现 | 需使用蓝牙 MAC 地址 + 厂商 SDK |
| **USB** | 未实现 | 需使用厂商 USB SDK |

#### 字符编码

- ESC/POS 模式: 文本使用 **GBK 编码**，这是中文热敏打印机的标准编码
- TSPL 模式: 使用字体 **TSS24.BF2**（简繁中文 24 点阵位图字体）

> **注意**: 如果打印出乱码，首先检查打印机是否支持 GBK 编码。部分东南亚/欧美打印机可能需要 UTF-8 编码或 Big5 编码。

---

### 3.4 配置管理

#### 功能描述

负责持久化保存和读取打印机连接配置。使用 Android 的 SharedPreferences 机制，数据保存在设备本地，APP 卸载后数据会被清除。

#### 数据模型

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `type` | String | `"WIFI"` | 连接类型：`WIFI` / `BLUETOOTH` / `USB` |
| `ip` | String | `""` (空) | 打印机 IP 地址（WiFi 模式使用） |
| `port` | int | `9100` | 打印端口号 |
| `macAddress` | String | `""` (空) | 蓝牙 MAC 地址（蓝牙模式使用） |

#### 接口说明

| 操作 | 方法 | 行为 |
|------|------|------|
| **保存** | `saveConfig()` | 异步写入 (`apply()`)，不阻塞调用线程 |
| **读取** | `loadConfig()` | 同步读取，返回配置数据对象 |

> **注意**: 保存操作使用 `apply()` 而非 `commit()`。`apply()` 是异步的，不会返回写入是否成功。在极端情况下（进程被立即杀死），数据可能丢失。但在本系统场景中，打印机配置不属于关键数据，使用 `apply()` 是合理的。

---

### 3.5 条码扫描

#### 功能描述

打开摄像头实时预览画面，利用 Google ML Kit 的条码识别引擎逐帧分析图像，检测到第一个有效条码后自动返回结果。

#### 设计要点

**1. 使用前置摄像头**

扫码功能**强制使用前置摄像头**，这是一个关键设计决策。原因是：KDS 平板通常竖立放置、屏幕面朝操作员，前置摄像头正好朝向顾客/柜台方向，方便扫描顾客出示的条码。

> **注意**: 如果设备没有前置摄像头，相机绑定会失败。系统会返回错误消息给 Web 端。

**2. 单次扫描即返回**

系统使用一个布尔标志 (`isScanProcessed`) 确保只返回第一个扫描到的条码结果。一旦检测到有效条码，立即设置结果并关闭扫描界面。

**3. 资源管理**

- 条码扫描器实例由扫描界面创建，在界面销毁时关闭（`onDestroy`）
- 图像分析使用单线程线程池，同样在 `onDestroy` 时关闭
- 使用 `STRATEGY_KEEP_ONLY_LATEST` 背压策略，丢弃来不及处理的帧，避免内存累积

#### 扫描流程

```
用户触发扫码 → 检查相机权限
  ├── 未授权 → 弹出权限请求
  │     ├── 用户同意 → 启动相机
  │     └── 用户拒绝 → 返回错误
  └── 已授权 → 启动相机
        │
        └── 逐帧分析图像
              ├── 未检测到条码 → 继续扫描下一帧
              └── 检测到条码 → 返回条码文本 → 关闭扫描界面
```

#### 返回值

| 结果 | 数据 |
|------|------|
| 成功 | 条码原始文本（`rawValue`），不限类型（QR Code、EAN-13、Code 128 等） |
| 失败/取消 | 错误描述字符串（如 "Camera permission was denied"） |

---

### 3.6 取证拍照

#### 功能描述

打开后置摄像头拍照，并强制将 GPS 定位信息、时间戳、设备信息写入照片的 EXIF 元数据。设计目的是为餐饮外卖配送、商品验收等场景提供带有地理坐标和时间证明的照片证据。

#### 设计要点

**1. GPS 强制模式 — 不定位不拍照**

这是本模块最重要的设计约束：**如果没有获取到 GPS 定位信息，拍照按钮不起作用**。用户点击拍照时，如果定位尚未就绪，系统会弹出提示并尝试重新获取 GPS，但不会执行拍照。

> **注意**: 在室内或 GPS 信号弱的环境中，这个限制可能导致用户无法拍照。GPS 获取使用了降级策略（见下文），但如果完全无法获取定位，用户将被阻塞。

**2. GPS 获取策略 — 三级降级**

```
第一优先: 高精度实时定位（PRIORITY_HIGH_ACCURACY）
  ├── 成功 → GPS 状态显示绿色 "GPS: Locked"
  └── 返回 null
       │
       └── 第二优先: 最后已知位置（lastLocation）
             ├── 成功 → GPS 状态显示黄色 "GPS: Last Known"
             └── 失败 → GPS 状态显示红色 "GPS: Unavailable"
                         此时拍照按钮不可用
```

**3. 双重 EXIF 写入 — 双保险机制**

照片的 GPS 信息通过两种方式写入：

| 写入方式 | 时机 | 说明 |
|----------|------|------|
| CameraX 元数据 | 拍照时自动 | 通过 `ImageCapture.Metadata.location` 设置，由 CameraX 自动写入 |
| 手动强制写入 | 拍照后 | 通过 ExifInterface API 再次手动写入所有 EXIF 标签 |

为什么需要双重写入？因为某些设备/厂商的 CameraX 实现可能不完整，不保证一定会写入 GPS EXIF。手动写入作为"保险"，确保 100% 写入。

**4. EXIF 写入并验证**

拍照后系统会立即读回照片的 EXIF，检查经纬度是否成功写入。验证结果会在 Log 中输出，拍照成功时还会 Toast 显示 GPS 坐标。

#### 写入的 EXIF 标签

| EXIF 标签 | 写入内容 |
|-----------|----------|
| GPS 经纬度 | 设备当前 GPS 坐标 |
| GPS 海拔 | 设备当前海拔（如可用） |
| 拍摄时间 | 当前日期时间 (`yyyy:MM:dd HH:mm:ss`) |
| 原始拍摄时间 | 同上 |
| 数字化时间 | 同上 |
| 设备制造商 | `"Google"` |
| 设备型号 | `"TopTeaKDS"` |
| 软件名称 | `"TopTeaKDS App"` |
| 时区偏移 | 设备当前时区（如 `+08:00`） |

> **注意**: 设备制造商设为 `"Google"` 而非实际设备制造商，这是刻意设计。如需改为真实设备信息，需修改此处逻辑。

#### 双返回模式

本模块有两种调用方式，返回数据格式不同：

| 调用来源 | 返回方式 | 场景 |
|----------|----------|------|
| **JS Bridge 调用** (`takeEvidencePhoto`) | 返回 Base64 编码的 JPEG 字符串 | Web 端 JS 调用拍照，需要在 Web 页面中显示或上传照片 |
| **WebView 文件选择器** (`<input type="file" capture>`) | 文件已保存到指定路径，返回文件 URI | Web 端 HTML 表单的文件上传控件触发 |

两种模式的区别在于是否传入了输出文件路径：
- 传入路径 → 照片保存到该路径，不返回数据，调用方通过文件 URI 访问
- 未传入路径 → 创建临时文件 → 拍照 → 读取为 Base64 → 删除临时文件 → 返回 Base64

> **注意**: Base64 模式下，大尺寸照片的 Base64 字符串可能非常长（几 MB），通过 `evaluateJavascript` 传递大字符串可能有性能问题。如遇此问题，建议在拍照端压缩图片质量或分辨率。

---

## 4. 数据流与交互时序

### 4.1 打印流程

```
 Web 应用                JS Bridge                 打印服务            配置管理        打印机
   │                        │                        │                  │             │
   │  printJob(json,ok,err) │                        │                  │             │
   │ ─────────────────────► │                        │                  │             │
   │                        │  切换到 IO 线程         │                  │             │
   │                        │ ─────────────────────► │                  │             │
   │                        │                        │  读取配置         │             │
   │                        │                        │ ───────────────► │             │
   │                        │                        │  返回 IP/端口    │             │
   │                        │                        │ ◄─────────────── │             │
   │                        │                        │                  │             │
   │                        │                        │  TCP Socket 连接               │
   │                        │                        │ ──────────────────────────────►│
   │                        │                        │  发送打印指令字节流             │
   │                        │                        │ ──────────────────────────────►│
   │                        │                        │  关闭连接                       │
   │                        │  打印成功               │                  │             │
   │                        │ ◄───────────────────── │                  │             │
   │  window.ok()           │                        │                  │             │
   │ ◄───────────────────── │                        │                  │             │
```

### 4.2 扫码流程

```
 Web 应用         JS Bridge            主入口              扫码界面         条码引擎
   │                 │                    │                   │               │
   │  startScan      │                    │                   │               │
   │ ──────────────► │                    │                   │               │
   │                 │  切换到 UI 线程     │                   │               │
   │                 │ ────────────────► │                   │               │
   │                 │                    │  跳转扫码界面     │               │
   │                 │                    │ ────────────────►│               │
   │                 │                    │                   │  打开前置摄像头│
   │                 │                    │                   │  逐帧分析     │
   │                 │                    │                   │ ─────────────►│
   │                 │                    │                   │  识别结果     │
   │                 │                    │                   │ ◄─────────────│
   │                 │                    │  返回条码文本     │               │
   │                 │                    │ ◄────────────────│               │
   │                 │                    │                   │               │
   │  window.ok(条码文本)                 │                   │               │
   │ ◄─────────────────────────────────── │                   │               │
```

### 4.3 取证拍照流程

```
 Web 应用       JS Bridge          主入口           拍照界面            GPS
   │               │                 │                 │                │
   │ takeEvidence  │                 │                 │                │
   │ Photo(ok,err) │                 │                 │                │
   │ ─────────────►│                 │                 │                │
   │               │ 切换到 UI 线程   │                 │                │
   │               │───────────────►│                 │                │
   │               │                 │  跳转拍照界面   │                │
   │               │                 │───────────────►│                │
   │               │                 │                 │  获取GPS定位   │
   │               │                 │                 │──────────────►│
   │               │                 │                 │  定位坐标      │
   │               │                 │                 │◄──────────────│
   │               │                 │                 │                │
   │               │                 │                 │ [用户点击拍照] │
   │               │                 │                 │ 拍照 + 写EXIF  │
   │               │                 │                 │ 验证EXIF       │
   │               │                 │                 │ 转Base64       │
   │               │                 │                 │                │
   │               │                 │  返回 Base64    │                │
   │               │                 │◄───────────────│                │
   │               │                 │                 │                │
   │ window.ok(base64)               │                 │                │
   │◄─────────────────────────────── │                 │                │
```

---

## 5. 权限模型与安全设计

### 5.1 所需权限

| 权限 | 类型 | 用途 | 使用场景 |
|------|------|------|----------|
| **网络访问** | 安装时自动授予 | WebView 加载远程页面 + WiFi Socket 打印 | 始终需要 |
| **摄像头** | 运行时请求 | 条码扫描 + 取证拍照 | 用户触发扫码或拍照时 |
| **精确位置** | 运行时请求 | 取证拍照写入 GPS EXIF | 用户触发拍照时 |
| **粗略位置** | 运行时请求 | 精确位置的降级方案 | 随精确位置一起请求 |
| **蓝牙扫描** | 运行时请求 | 蓝牙打印机发现 | 配置蓝牙打印机时（未实现） |
| **蓝牙连接** | 运行时请求 | 蓝牙打印机连接 | 蓝牙打印时（未实现） |

> **注意**: 应用声明了 `android.hardware.camera` 为必需硬件特性 (`required="true"`)。这意味着没有摄像头的设备（如部分 POS 机）将无法在 Play Store 中安装此应用。如果需要支持无摄像头设备，应改为 `required="false"` 并在代码中做功能降级。

### 5.2 权限请求时机

权限不在 APP 启动时统一请求，而是**按需请求**：

| 功能 | 请求的权限 | 请求时机 |
|------|-----------|----------|
| 条码扫描 | 仅 `CAMERA` | 打开扫码界面时 |
| 取证拍照 | `CAMERA` + `ACCESS_FINE_LOCATION` + `ACCESS_COARSE_LOCATION` | 打开拍照界面时 |
| WebView 文件拍照 | `CAMERA` + `ACCESS_FINE_LOCATION` + `ACCESS_COARSE_LOCATION` | Web 页面触发文件选择器时 |

### 5.3 安全设计

#### 网络安全

- **允许明文 HTTP 流量** (`usesCleartextTraffic="true"`) — 因为 WiFi 打印机通信走内网 TCP Socket，不支持 TLS
- **允许混合内容** — Web 应用的 HTTPS 页面可能加载内网 HTTP 资源

> **注意**: 这些设置降低了网络安全性。在公网部署时应考虑收紧：使用 `network_security_config.xml` 仅对打印机 IP 段允许明文流量。

#### JavaScript Bridge 安全

- 仅暴露 4 个必要的接口方法，不暴露敏感系统 API
- 回调参数通过 `JSONObject.quote()` 安全转义，防止 JavaScript 注入
- 回调执行包裹在 `try-catch` 中，Web 端函数不存在不会导致 APP 崩溃

#### 错误页面安全

- 加载失败时不向用户显示 URL（防止内网地址泄露）
- 仅在 Android 系统日志中记录详细错误信息

#### 文件访问安全

- 使用 FileProvider 对外共享文件，不直接暴露文件系统路径
- FileProvider 设为不可导出 (`exported="false"`)，仅通过授权 URI 临时授予访问权限
- 访问范围限定在外部缓存目录和内部文件目录

---

## 6. UI 交互设计

### 6.1 主界面

全屏 WebView，无原生 UI 控件。所有用户交互通过 Web 页面完成。支持 Edge-to-Edge 全屏显示（利用系统栏区域）。

### 6.2 扫码界面

全屏摄像头预览画面，无任何按钮或 UI 控件。用户只需将条码对准摄像头区域，系统检测到条码后自动关闭界面返回结果。

> **注意**: 当前设计没有"手动关闭"按钮。如果用户误触发扫码且没有条码可扫，只能通过系统返回键退出（此时会返回"取消"结果）。

### 6.3 拍照界面

横屏布局，黑色背景，包含以下 UI 元素：

| 元素 | 位置 | 功能 |
|------|------|------|
| **摄像头预览** | 全屏背景 | 后置摄像头实时画面 |
| **GPS 状态指示器** | 左上角 | 显示 GPS 定位状态，颜色编码：绿色=已锁定、黄色=使用历史位置、红色=不可用 |
| **快门按钮** | 右侧垂直居中 | 白色圆环+实心圆设计（类似 iOS 相机按钮），80x80dp |
| **取消按钮** | 左下角 | 文字按钮 "Cancel"，点击后取消拍照返回 |
| **加载指示器** | 屏幕中央 | 拍照后显示旋转进度条 + "Processing..." 文字，拍照期间隐藏快门键 |

**拍照期间的 UI 状态变化**:
- 点击快门后：快门按钮隐藏、取消按钮禁用、显示加载进度
- 处理完成后：恢复所有按钮状态（如果出错）或关闭界面（如果成功）

---

## 7. 注意事项与设计约束

### 7.1 Web 端开发注意事项

1. **回调函数必须挂在 `window` 上**: JS Bridge 的回调机制要求回调函数是全局可访问的。不能使用闭包或模块私有函数
2. **回调函数名不能包含特殊字符**: 函数名被直接拼接到 `javascript:` 协议的 JS 代码中，应仅包含字母、数字、下划线
3. **每次调用的回调函数名应唯一**: 如果连续调用两次 `printJob` 并使用同一个回调名，第二次调用的回调可能覆盖第一次的结果
4. **Base64 照片可能很大**: `takeEvidencePhoto` 返回的 Base64 字符串可能达到几 MB，Web 端应做好大数据接收准备

### 7.2 打印相关注意事项

1. **WiFi 打印机必须在同一局域网**: 打印使用 TCP Socket 直连，打印机必须与平板在同一网段
2. **默认端口 9100**: 这是热敏打印机的标准 RAW 打印端口，大多数打印机开箱即用
3. **GBK 编码假设**: 当前所有 ESC/POS 文本强制使用 GBK 编码。如果打印机不支持 GBK（如部分海外型号），需要修改编码
4. **TSPL 标签间隙**: 默认设为 2mm。不同标签纸的间隙不同，可能需要根据实际标签纸调整
5. **打印机连接是一次性的**: 每次打印都建立新的 Socket 连接，打印完毕立即关闭。不维持长连接

### 7.3 扫码相关注意事项

1. **前置摄像头固定**: 当前硬编码使用前置摄像头，如需使用后置摄像头需要修改代码
2. **环境光线影响**: 条码识别对光线敏感。在厨房强油烟/弱光环境下识别率可能下降
3. **单次扫描**: 每次启动只返回第一个条码结果，如需连续扫描需要重新调用 `startScan`

### 7.4 拍照相关注意事项

1. **GPS 强制**: 没有 GPS 信号时用户无法拍照，这在室内环境可能是个问题
2. **GPS 首次定位**: 首次打开 GPS 可能需要较长时间（冷启动），用户需要等待
3. **时区偏移格式**: EXIF 时区格式要求 `+HH:MM`（如 `+08:00`），代码中做了格式转换，但只处理了 5 位标准格式

### 7.5 通用注意事项

1. **横屏锁定**: 所有界面强制横屏。如果 Web 应用包含竖屏优化的页面，显示可能不理想
2. **缓存每次清除**: 用户每次打开 APP 都会重新加载所有 Web 资源，在弱网环境下体验较差
3. **ProGuard 未启用**: 当前关闭了代码混淆。启用混淆前必须添加规则保留 `@JavascriptInterface` 注解的方法，否则 JS Bridge 会失效
4. **明文流量**: 当前允许所有明文 HTTP 流量。如果 KDS Web 应用部署在公网，应考虑仅对打印机内网 IP 允许明文

---

## 8. 待实现功能

| 编号 | 功能 | 说明 | 优先级 |
|------|------|------|--------|
| T-001 | 蓝牙打印 | 需集成厂商蓝牙 SDK，通过 MAC 地址建立连接并发送打印数据 | 中 |
| T-002 | USB 打印 | 需集成厂商 USB SDK，建立 USB 连接并发送打印数据 | 中 |
| T-003 | ESC/POS 文本格式化 | 当前 `text` 指令不支持字体大小、对齐方式等参数，需要补充 ESC/POS 字号切换和对齐指令 | 中 |
| T-004 | TSPL 分隔线 | TSPL 模式下 `divider` 指令尚未实现，可使用 `BAR` 指令画线 | 低 |
| T-005 | TSPL 高级配置 | 标签打印的 DENSITY（浓度）、SPEED（速度）等初始化参数尚未支持 | 低 |
| T-006 | TSPL 标签间隙可配置 | 当前硬编码 2mm 间隙，应支持 Web 端通过 JSON 指定或通过配置管理设置 | 低 |
| T-007 | Release 签名 | 正式发布前需配置有效的 Release Keystore 签名 | 高 |
| T-008 | ProGuard 配置 | 启用代码混淆，并添加规则保留 JS Bridge 方法 | 中 |

---

> **文档结束**
